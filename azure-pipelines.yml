# Node.js with Angular
# Build a Node.js project that uses Angular.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
  - main

pool:
  vmImage: ubuntu-latest

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: "14.x"
    displayName: "Install Node.js"

  - task: Npm@1
    displayName: "npm install angular cli"
    inputs:
      command: custom

      verbose: false

      customCommand: "install @angular/cli -g"

  - task: Npm@1
    displayName: "npm install packages"
    inputs:
      verbose: false

  - script: "npm run build:ssr"
    displayName: "build the project"

  - task: CopyFiles@2
    displayName: "Copy client to the root"
    inputs:
      SourceFolder: "$(Build.SourcesDirectory)/dist/clinic/browser"

      TargetFolder: "$(Build.ArtifactStagingDirectory)/deploy-dist/browser"

  - task: CopyFiles@2
    displayName: "Copy server files to staging"
    inputs:
      SourceFolder: "$(Build.SourcesDirectory)/dist/clinic/server"

      TargetFolder: "$(Build.ArtifactStagingDirectory)/deploy-dist"

  - task: PowerShell@2
    displayName: "Copy Specific Config"
    inputs:
      targetType: inline
      script: Copy-Item -Path "$(Build.ArtifactStagingDirectory)/deploy-dist/main.js" -Destination "$(Build.ArtifactStagingDirectory)/deploy-dist/index.js"

  - task: AzureRmWebAppDeployment@4
    displayName: "Azure App Service Deploy: website"
    inputs:
      azureSubscription: myAngularService

      WebAppName: angular-ssr

      DeployToSlotFlag: true

      ResourceGroupName: admin

      packageForLinux: dist

      GenerateWebConfig: true

      WebConfigParameters: "-Handler iisnode -NodeStartFile index.js -appType node"

      UseWebDeploy: false

      RemoveAdditionalFilesFlag: true
